name: Build Azan Installer

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build_windows_installer:
    runs-on: windows-latest
    outputs:
      win_installer: ${{ steps.out_win.outputs.win_installer }}

    steps:
      - name: Checkout Azan repo
        uses: actions/checkout@v4

      - name: Download AzanScheduler artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: AzanScheduler-Build.yml
          repo: MoRefaie/AzanScheduler
          workflow_conclusion: success
          name: AzanScheduler-win
          path: ./dist/AzanScheduler-win

      - name: Download AzanUI artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: AzanUI-Build.yml
          repo: MoRefaie/AzanUI
          workflow_conclusion: success
          name: AzanUI-win
          path: ./dist/AzanUI-win
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Move executables to dist
        run: |
          move ./dist/AzanScheduler-win/AzanScheduler.exe ./dist/AzanScheduler.exe
          move ./dist/AzanUI-win/AzanUI.exe ./dist/AzanUI.exe

      - name: Install Inno Setup
        run: choco install innosetup --no-progress

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" azan-setup.iss

      - name: Upload Windows installer artifact
        id: out_win
        uses: actions/upload-artifact@v4
        with:
          name: AzanInstaller-win
          path: ./dist/Azan_setup.exe

  build_linux_installer:
    runs-on: ubuntu-latest
    outputs:
      linux_installer: ${{ steps.out_linux.outputs.linux_installer }}

    steps:
      - name: Checkout Azan repo
        uses: actions/checkout@v4

      - name: Download AzanScheduler Linux artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: AzanScheduler-Build.yml
          repo: MoRefaie/AzanScheduler
          workflow_conclusion: success
          name: AzanScheduler-linux
          path: ./dist/AzanScheduler-linux

      - name: Download AzanUI Linux artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: AzanUI-Build.yml
          repo: MoRefaie/AzanUI
          workflow_conclusion: success
          name: AzanUI-linux
          path: ./dist/AzanUI-linux

      - name: Make binaries executable
        run: chmod +x ./dist/AzanScheduler-linux/AzanScheduler ./dist/AzanUI-linux/AzanUI

      - name: Prepare tarball contents
        run: |
          mv ./dist/AzanScheduler-linux/AzanScheduler .
          mv ./dist/AzanUI-linux/AzanUI .

      - name: Package Linux installer
        run: |
          tar -czvf Azan-linux-installer.tar.gz AzanScheduler AzanUI

      - name: Upload Linux installer artifact
        id: out_linux
        uses: actions/upload-artifact@v4
        with:
          name: AzanInstaller-linux
          path: Azan-linux-installer.tar.gz

  release:
    needs: [build_windows_installer, build_linux_installer]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: AzanInstaller-win

      - name: Download Linux installer
        uses: actions/download-artifact@v4
        with:
          name: AzanInstaller-linux

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: AzanUI ${{ github.ref_name }}
          files: |
            Azan_setup.exe
            Azan-linux-installer.tar.gz
